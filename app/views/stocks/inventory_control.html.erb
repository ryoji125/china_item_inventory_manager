<style type="text/css">
#table_detail .hidden_row{
 display:none;
}
</style>
<script>
  $(function() {
    //.accordion1の中のp要素がクリックされたら
    $('.accordion1 p').click(function() {
      //クリックされた.accordion1の中のp要素に隣接するul要素が開いたり閉じたりする。
      $(this).next('ul').slideToggle();
    });
  });
  $(function() {
    //ファイルが選択されたときに下記のchange()が作動
      $('#file').change(function(){
      //idがfoo要素のsubmitボタンを押す処理を行う。
      $('form')[0].submit().click('submit');
    });
  });
  function show_hide_row( row ) {
    $( "." + row ).toggle();
  }
</script>
<div class="container">
  <div class="row row-height">
    <div class="col-sm-3 lead" style="margin-left:30px">僅少商品一覧</div>
    <div class="col-sm-3">
      <div style="display:inline-flex">
        <div class="btn btn-warning">現在の想定レート</div>
        <input type="text" name="名前" class="textbox-cs" readonly></input>
      </div>
    </div>
    <div class="col-sm-1"></div>
  </div>
  <div>
    <section id="acdemo1">
      <div class="accordion1">
        <p class="btn btn-primary btn-xs right acstyle" style="margin-left:35px">表示/非表示</p>
        <ul class="inner">
          <div id="mymenu">
            <div class="kousin">
              <table table border="1" class="table-back">
                <thead>
                  <tr>
                    <th width="500">商品タイトル</th>
                    <th class="th-text" width="120" align="right">在庫数合計</th>
                  </tr>
                </thead>
            </div>
            <% @items.each do |item| %>
            <% stockcount=item.stocks.sum(:stock)  %>
              <% if stockcount<20 %>
                <tr>
                  <td><%= item.item_title %></td>
                <td><%= item.stocks.sum(:stock)  %></td>
                </tr>
              <% end %>
            <% end %>
            </table>
        </ul>
      </div>
    </section>
    <br>
    <% admin=false %>
    <% admin=current_user.admin if current_user %>
    <% if admin==true %>
    <div class="row" style="margin-left:30px">
      <div class="col-xs-1">
        <%= form_with url: import_items_path, multipart: true, id: "foo" do %>
          <label>
          <%= file_field_tag :file, class: "input-default"  %>
          <div class="btn-square-so-pop center">インポート</div>
          <%= submit_tag "インポート" ,class: "input-default" %>
          </label>
        <% end %>
      </div>
      <% end %>
      <div class="col-xs-1"></div>
        <div class="col-xs-1">
          <%= button_to "エクスポート", {controller: 'stocks', action: 'csv_export',items_find: @search,format: :csv}, {method: :post, class: "btn-square-so-pop"} %>
        </div>
      </div>
  </div>
  <br>
  <div class="row">
    <div class="col-xs-6">
      <%= form_with :action=>"inventory_control", :controller=>"stocks" , method: :get, local: true do |form| %>
      <p style="margin-left:30px">商品名及び製品番号検索：<%= text_field_tag :search, params[:search] %>
        <%= hidden_field_tag :kubun, "1"  %>
        <%= submit_tag "検索", :name => nil,class: "btn-square-so-pop", data: { disable_with: "検索中" }  %>
      </p>
      <% end %>
    </div>
    <div class="col-xs-1">
      <%= form_with(url: "/items/destroy_many", method: :delete, local: true) do |form| %>
      <%= form.submit '一括削除', class: 'btn-square-so-pop red', data: { confirm: '本当に削除しますか？' } %>
      </div>
    <div class="col-xs-5"></div></div>
    <div class="col-xs-1"></div>
  </div>
  <section id="acdemo1">
    <div class="accordion1">
      &emsp; &emsp; &emsp; <p class="btn btn-primary btn-xs right style" "display:inline;">表示/非表示</p>
      <% if @items_find.present? %>
      <%= "検索件数#{@items_find.count}件です" %>
      <ul class="inner">
        <div class="kousin2">
          <table table border="1" id="table_detail" class="table-back22">
            <thead>
              <tr class="tr-back2">
                <th width="5" width="30">商品画像</th>
                <th width="50">製品コード</th>
                <th width="20">商品タイトル</th>
                <th width="60">在庫計</th>
                <th width="80">想定価格</th>
                <th width="170">出品サイト</th>
                <th width="30">削除</th>
              </tr>
            </thead>
        </div>
        <% i=1 %>
        <% @items_find.each do |item| %>
        <% yahoo=item.yahoo %>
        <% amazon=item.amazon %>
        <% mercari=item.mercari %>
        <% rakuma=item.rakuma %>
        <% rakuten=item.rakuten %>
        <% yahooshoping=item.yahooshoping %>
        <% k=i%2 %>
        <tr  class="tr-back<%= k %>">
          <td onclick="show_hide_row('hidden_row<%=i %>')"; >
            <% if item.item_picture.present? %>
              <% uri=URI.parse(item.item_picture) %>
              <% if uri.scheme=="https" or uri.scheme=="http" %>
                <%= image_tag item.item_picture, :size =>'50x25' %>
              <% end %>
            <% end %>
          </td>
          <td><%= item.part_number %></td>
          <td width="500" align="left"><%= item.item_title%></td>
          <td>
          <% if item.stocks.sum(:stock)<20 %>
            <font color="red">
          <% end %>
          <%= item.stocks.sum(:stock)  %></td>
          <td><%= item.simulate_price.to_s(:delimited, delimiter: ',') %></td>
          <td><%= exhibition(yahoo,amazon,mercari,rakuma,rakuten,yahooshoping) %></td>
          <td><%= check_box_tag "deletes[#{ item.id }]", item.id %></td>
        </tr>
        <% stocks=Stock.where(item_id:item.id)%>
        
        <% classname="hidden_row hidden_row"+i.to_s %>
        <% if stocks.count>0 %>
        <tr>
          <tr class="<%= classname %> tr-sub-back2"><th colspan="2">仕入日</th><th>購入業者</th><th>在庫数</th><th>仕入原価</th><th>編集</th></tr>
          <% y=1 %>
        <% stocks.each do |stock| %>
          <% u=y%2 %>
          <tr class="<%= classname %> tr-sub-back<%= u %>">
            <td colspan="2"><%= stock.inventory_arrival_date %></td>
            <td><%= stock.trader_name %></td>
              <td><%= stock.stock %></td>
            <td><%= stock.purchase_price.to_s(:delimited, delimiter: ',') if stock.purchase_price.present? %></td>
            <td><%= link_to "編集", "/stocks/#{stock.id}/edit" %></td>
            </tr>
          <% y=y+1 %>
        <% end %>
        </tr>
        <% end %>
        <% i=i.to_i+1 %>
        <% end %>
        <% end %>
        <% end %>
        </table>
  </section>
  </div>
  </div>
</div>
